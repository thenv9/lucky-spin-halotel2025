<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Customer Care Halotel lucky spin</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,sans-serif;text-align:center;background:#f4f4f9;padding-top:20px;}
    input{margin:5px;padding:8px;border-radius:5px;border:1px solid #ccc;font-size:14px;}
    button{padding:10px 20px;margin:10px;border:none;border-radius:5px;background:linear-gradient(45deg,#4CAF50,#81C784);color:#fff;font-size:16px;cursor:pointer;transition:background .3s;}
    button:hover{background:linear-gradient(45deg,#388E3C,#66BB6A);}
    h2{font-size:26px;margin-bottom:20px;}
    .wheel-wrap{position:relative;width:500px;margin:0 auto;}
    #canvas{background:#fff;border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,.2);display:block;margin:0 auto;}
    /* Kim ·ªü ch√≠nh gi·ªØa ph√≠a tr√™n, h∆∞·ªõng xu·ªëng */
    #pointer{position:absolute;left:50%;transform:translateX(-50%);width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-top:36px solid red;top:-6px;z-index:10;}
  </style>
</head>
<body>
  <h2>üéØ Customer Care Halotel lucky spin</h2>

  <input type="text" id="branch" placeholder="Enter Branch">
  <input type="text" id="phone" placeholder="Enter Phone Number"><br>

  <button onclick="startSpin()">Spin</button>
  <button onclick="resetWheel()">Reset</button><br><br>

  <div class="wheel-wrap">
    <div id="pointer"></div>
    <canvas id="canvas" width="500" height="500"></canvas>
  </div>

  <script>
    // Easing: ch·∫≠m d·∫ßn ƒë·ªÅu
    const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

    class Winwheel{
      constructor(props){
        this.segments = props.segments;
        this.numSegments = props.numSegments;
        this.outerRadius = props.outerRadius || 240;
        this.animation = props.animation;
        const canvas = document.getElementById(props.canvasId);
        this.ctx = canvas.getContext('2d');
        this.cw = canvas.width; this.ch = canvas.height;
        this.cx = this.cw/2; this.cy = this.ch/2;

        this.angle = 0;          // g√≥c hi·ªán t·∫°i (ƒë·ªô)
        this.isSpinning = false; // ch·ªëng b·∫•m nhi·ªÅu l·∫ßn
        this.draw();
      }

      draw(){
        const ctx = this.ctx;
        const segRad = (2*Math.PI)/this.numSegments;

        ctx.clearRect(0,0,this.cw,this.ch);
        ctx.save();
        ctx.translate(this.cx, this.cy);
        ctx.rotate(this.angle * Math.PI/180);

        for(let i=0;i<this.numSegments;i++){
          const start = i*segRad, end = start + segRad;
          ctx.beginPath(); ctx.moveTo(0,0);
          ctx.arc(0,0,this.outerRadius,start,end);
          ctx.closePath();
          ctx.fillStyle = this.segments[i].fillStyle; ctx.fill();

          ctx.save();
          ctx.rotate(start + segRad/2);
          ctx.fillStyle = '#fff'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'right';
          ctx.fillText(this.segments[i].text, this.outerRadius - 10, 5);
          ctx.restore();
        }
        ctx.restore();
      }

      /** Quay ch·∫≠m d·∫ßn ƒë·ªÉ d·ª´ng ƒë√∫ng √¥ targetIndex */
      spinToIndex(targetIndex, spins=6, duration=6){
        if(this.isSpinning) return;
        this.isSpinning = true;

        const segA = 360/this.numSegments;
        const pointerDeg = 270; // kim ·ªü 12 gi·ªù

        // G√≥c t√¢m √¥ target trong tr·∫°ng th√°i g·ªëc (angle = 0)
        const targetCenter = targetIndex*segA + segA/2; // 0..360 theo chi·ªÅu kim ƒë·ªìng h·ªì t·ª´ h∆∞·ªõng 3 gi·ªù

        // G√≥c tuy·ªát ƒë·ªëi c·∫ßn d·ª´ng: ƒë∆∞a targetCenter v·ªÅ ƒë√∫ng 270¬∞
        const targetAbs = ((pointerDeg - targetCenter) % 360 + 360) % 360; // 0..360

        // G√≥c hi·ªán t·∫°i (0..360)
        const startAngle = ((this.angle % 360) + 360) % 360;

        // Œî g√≥c t·ª´ tr·∫°ng th√°i hi·ªán t·∫°i ƒë·∫øn g√≥c tuy·ªát ƒë·ªëi
        const deltaToTarget = ((targetAbs - startAngle) % 360 + 360) % 360;

        // T·ªïng g√≥c quay th√™m (k√®m s·ªë v√≤ng ƒë·∫ßy)
        const totalDelta = spins*360 + deltaToTarget;

        const startTime = performance.now();
        const durMs = duration*1000;

        const animate = (now)=>{
          const t = Math.min((now - startTime)/durMs, 1);
          const eased = easeOutCubic(t);
          this.angle = startAngle + totalDelta*eased;
          this.draw();

          if(t < 1){
            requestAnimationFrame(animate);
          }else{
            this.angle = (startAngle + totalDelta) % 360; // chu·∫©n h√≥a
            this.draw();
            this.isSpinning = false;
            this.animation.callbackFinished({ text: this.segments[targetIndex].text, index: targetIndex });
          }
        };
        requestAnimationFrame(animate);
      }
    }

    // Kh·ªüi t·∫°o
    const wheel = new Winwheel({
      canvasId: 'canvas',
      numSegments: 6,
      outerRadius: 240, // thu nh·ªè vi·ªÅn tr·∫Øng
      segments: [
        { fillStyle:'#f44336', text:'AIRTIME 500 TSH' },
        { fillStyle:'#e91e63', text:'10 MINS CALL' },
        { fillStyle:'#9c27b0', text:'50 SMS' },
        { fillStyle:'#3f51b5', text:'200MB DATA' },
        { fillStyle:'#03a9f4', text:'500 POINTS VUNA' },
        { fillStyle:'#4caf50', text:'1000 POINTS VUNA' },
      ],
      animation:{
        duration: 6,   // gi√¢y
        spins: 6,      // s·ªë v√≤ng ƒë·∫ßy
        callbackFinished: logResult
      }
    });

    function startSpin(){
      // B·ªëc ng·∫´u nhi√™n 1 √¥ th·∫Øng
      const idx = Math.floor(Math.random() * wheel.numSegments);
      // Quay ch·∫≠m d·∫ßn ƒë√∫ng v√†o √¥ ƒë√≥
      wheel.spinToIndex(idx, wheel.animation.spins, wheel.animation.duration);
    }

    function resetWheel(){
      if(wheel.isSpinning) return;
      wheel.angle = 0;
      wheel.draw();
      document.getElementById('branch').value = '';
      document.getElementById('phone').value = '';
    }

    function logResult(r){
      const branch = document.getElementById('branch').value.trim();
      const phone  = document.getElementById('phone').value.trim();
      const reward = r.text;

      if(!branch || !phone){
        alert('‚ö†Ô∏è Please enter Branch and Phone Number!');
        return;
      }

      alert('üéâ Congratulations! You won: ' + reward);

      // ƒê·∫©y sang Google Apps Script
      const scriptUrl = 'https://script.google.com/macros/s/AKfycbyBwfmlJHwCJwVP19ZevVFMxTIbVu6nlC4Emaknh1WOwqoKaFxSpC9SUZ56stPUEKs/exec';
      const url = scriptUrl +
        '?branch=' + encodeURIComponent(branch) +
        '&phone=' + encodeURIComponent(phone) +
        '&reward=' + encodeURIComponent(reward);

      fetch(url, { method:'GET' })
        .then(res => res.json())
        .then(data => console.log('‚úÖ Result sent:', data))
        .catch(err => console.error('‚ùå Cannot connect to Google Script!', err));
    }
  </script>
</body>
</html>
