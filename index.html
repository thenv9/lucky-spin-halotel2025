<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Lucky Wheel</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,sans-serif;text-align:center;background:#f4f4f9;padding-top:20px;}
    input{margin:5px;padding:8px;border-radius:5px;border:1px solid #ccc;font-size:14px;}
    button{padding:10px 20px;margin:10px;border:none;border-radius:5px;background:linear-gradient(45deg,#4CAF50,#81C784);color:#fff;font-size:16px;cursor:pointer;transition:background .3s;}
    button:hover{background:linear-gradient(45deg,#388E3C,#66BB6A);}
    h2{font-size:26px;margin-bottom:20px;}

    .wheel-wrap{position:relative;width:500px;margin:0 auto;}
    #canvas{background:#fff;border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,.2);display:block;margin:0 auto;}

    /* Kim tam gi√°c ·ªü tr√™n, h∆∞·ªõng xu·ªëng */
    #pointer{
      position:absolute;
      left:50%;transform:translateX(-50%);
      width:0;height:0;
      border-left:18px solid transparent;
      border-right:18px solid transparent;
      border-top:36px solid red;
      top:-6px;z-index:10;
    }
  </style>
</head>
<body>
  <h2>üéØ Lucky Wheel</h2>

  <input type="text" id="branch" placeholder="Enter Branch">
  <input type="tel" id="phone" placeholder="Enter Phone Number"><br>

  <button id="spinBtn" onclick="startSpin()">Spin</button>
  <button onclick="resetWheel()">Reset</button><br><br>

  <div class="wheel-wrap">
    <div id="pointer"></div>
    <canvas id="canvas" width="500" height="500"></canvas>
  </div>

  <script>
    const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

    class Winwheel{
      constructor(props){
        this.segments = props.segments;
        this.numSegments = props.numSegments;
        this.outerRadius = props.outerRadius || 240;
        this.animation = props.animation;
        const canvas = document.getElementById(props.canvasId);
        this.ctx = canvas.getContext('2d');
        this.cw = canvas.width; this.ch = canvas.height;
        this.cx = this.cw/2; this.cy = this.ch/2;

        this.angle = 0;
        this.isSpinning = false;
        this.draw();
      }

      draw(){
        const ctx = this.ctx;
        const segRad = (2*Math.PI)/this.numSegments;

        ctx.clearRect(0,0,this.cw,this.ch);
        ctx.save();
        ctx.translate(this.cx, this.cy);
        ctx.rotate(this.angle * Math.PI/180);

        for(let i=0;i<this.numSegments;i++){
          const start = i*segRad, end = start + segRad;
          ctx.beginPath(); ctx.moveTo(0,0);
          ctx.arc(0,0,this.outerRadius,start,end);
          ctx.closePath();
          ctx.fillStyle = this.segments[i].fillStyle; ctx.fill();

          ctx.save();
          ctx.rotate(start + segRad/2);
          ctx.fillStyle = '#fff'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'right';
          ctx.fillText(this.segments[i].text, this.outerRadius - 10, 5);
          ctx.restore();
        }
        ctx.restore();
      }

      spinToIndex(targetIndex, spins=6, duration=6){
        if(this.isSpinning) return;
        this.isSpinning = true;

        const segA = 360/this.numSegments;
        const pointerDeg = 270; // kim ·ªü 12 gi·ªù

        const targetCenter = targetIndex*segA + segA/2;
        const targetAbs = ((pointerDeg - targetCenter) % 360 + 360) % 360;

        const startAngle = ((this.angle % 360) + 360) % 360;
        const deltaToTarget = ((targetAbs - startAngle) % 360 + 360) % 360;
        const totalDelta = spins*360 + deltaToTarget;

        const btn = document.getElementById('spinBtn');
        if (btn) btn.disabled = true;

        const startTime = performance.now();
        const durMs = duration*1000;

        const animate = (now)=>{
          const t = Math.min((now - startTime)/durMs, 1);
          const eased = easeOutCubic(t);
          this.angle = startAngle + totalDelta*eased;
          this.draw();

          if(t < 1){
            requestAnimationFrame(animate);
          }else{
            this.angle = (startAngle + totalDelta) % 360;
            this.draw();
            this.isSpinning = false;
            if (btn) btn.disabled = false;
            this.animation.callbackFinished({ text: this.segments[targetIndex].text, index: targetIndex });
          }
        };
        requestAnimationFrame(animate);
      }
    }

    const wheel = new Winwheel({
      canvasId: 'canvas',
      numSegments: 6,
      outerRadius: 240,
      segments: [
        { fillStyle:'#f44336', text:'AIRTIME 500 TSH' },
        { fillStyle:'#e91e63', text:'10 MINS CALL' },
        { fillStyle:'#9c27b0', text:'50 SMS' },
        { fillStyle:'#3f51b5', text:'200MB DATA' },
        { fillStyle:'#03a9f4', text:'500 POINTS VUNA' },
        { fillStyle:'#4caf50', text:'1000 POINTS VUNA' },
      ],
      animation:{
        duration: 6,
        spins: 6,
        callbackFinished: logResult
      }
    });

    function startSpin(){
      const branch = document.getElementById('branch').value.trim();
      const phone  = document.getElementById('phone').value.trim();

      if(!branch){
        alert('‚ö†Ô∏è Please enter Branch!');
        return;
      }
      if(!phone){
        alert('‚ö†Ô∏è Please enter Phone Number!');
        return;
      }

      const idx = Math.floor(Math.random() * wheel.numSegments);
      wheel.spinToIndex(idx, wheel.animation.spins, wheel.animation.duration);
    }

    function resetWheel(){
      if(wheel.isSpinning) return;
      wheel.angle = 0;
      wheel.draw();
      document.getElementById('branch').value = '';
      document.getElementById('phone').value = '';
    }

    function logResult(r){
      const branch = document.getElementById('branch').value.trim();
      const phone  = document.getElementById('phone').value.trim();
      const reward = r.text;

      alert('üéâ Congratulations! You won: ' + reward);

      const scriptUrl = 'https://script.google.com/macros/s/AKfycbyBwfmlJHwCJwVP19ZevVFMxTIbVu6nlC4Emaknh1WOwqoKaFxSpC9SUZ56stPUEKs/exec';
      const url = scriptUrl +
        '?branch=' + encodeURIComponent(branch) +
        '&phone=' + encodeURIComponent(phone) +
        '&reward=' + encodeURIComponent(reward);

      fetch(url, { method:'GET' })
        .then(res => res.json())
        .then(data => console.log('‚úÖ Result sent:', data))
        .catch(err => console.error('‚ùå Cannot connect to Google Script!', err));
    }
  </script>
</body>
</html>
